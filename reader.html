<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Yuuutabia Reader</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>

<style>
body {
  margin: 0;
  background: #f1f5f9;
  font-family: Arial, sans-serif;
  overflow-x: hidden;
}

/* FULLSCREEN MODE */
.fullscreen {
  background: black;
}

.fullscreen #modeToggle {
  opacity: 0.7;
}

/* FLOATING MODE BUTTON */
#modeToggle {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: #111827;
  color: white;
  padding: 12px 16px;
  border-radius: 30px;
  font-size: 14px;
  cursor: pointer;
  z-index: 999;
  box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

/* PAGE CONTROLS */
#pageControls {
  position: fixed;
  bottom: 0;
  width: 100%;
  background: #111827;
  padding: 10px;
  text-align: center;
  z-index: 998;
}

button {
  padding: 6px 10px;
  margin: 3px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}

#page-slider {
  width: 70%;
}

/* PROGRESS BAR */
#progressBar {
  position: fixed;
  top: 0;
  left: 0;
  height: 3px;
  background: #6366f1;
  width: 0%;
  z-index: 1000;
}

/* CONTAINER */
#pdf-container {
  margin-bottom: 90px;
  text-align: center;
}

canvas {
  max-width: 100%;
  margin-bottom: 15px;
}

.slide {
  animation: slideIn 0.3s ease;
}

@keyframes slideIn {
  from { transform: translateX(40px); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}
</style>
</head>

<body>

<div id="progressBar"></div>
<div id="pdf-container"></div>

<div id="modeToggle" onclick="toggleMode()">
  Switch Mode
</div>

<div id="pageControls">
  <button onclick="prevPage()">⬅</button>
  <button onclick="nextPage()">➡</button>
  <br>
  <input type="range" id="page-slider" min="1" value="1">
  <span id="page-num"></span>
</div>

<script>

let urlParams = new URLSearchParams(window.location.search);
let book = urlParams.get("book");

let pdfDoc = null;
let currentPage = 1;
let mode = localStorage.getItem("readerMode") || "page";
let savedPage = localStorage.getItem(book + "-lastPage");

pdfjsLib.getDocument(book).promise.then(function(pdf){
  pdfDoc = pdf;

  if(savedPage){
    currentPage = parseInt(savedPage);
  }

  document.getElementById("page-slider").max = pdf.numPages;
  applyMode();
});

/* ================= MODE ================= */

function toggleMode(){
  mode = mode === "page" ? "scroll" : "page";
  localStorage.setItem("readerMode", mode);
  applyMode();
}

function applyMode(){
  document.getElementById("pdf-container").innerHTML = "";

  if(mode === "scroll"){
    document.getElementById("pageControls").style.display = "none";
    renderScroll();
  } else {
    document.getElementById("pageControls").style.display = "block";
    renderPage(currentPage);
  }
}

/* ================= PAGE MODE ================= */

function renderPage(num){
  document.getElementById("pdf-container").innerHTML = "";

  pdfDoc.getPage(num).then(function(page){

    let viewport = page.getViewport({scale: 1.3});
    let canvas = document.createElement("canvas");
    let ctx = canvas.getContext("2d");

    canvas.height = viewport.height;
    canvas.width = viewport.width;
    canvas.classList.add("slide");

    document.getElementById("pdf-container").appendChild(canvas);

    page.render({
      canvasContext: ctx,
      viewport: viewport
    });

    document.getElementById("page-num").textContent =
      "Page " + num + " / " + pdfDoc.numPages;

    document.getElementById("page-slider").value = num;

    updateProgress();
    savePage();
  });
}

function nextPage(){
  if(currentPage >= pdfDoc.numPages) return;
  currentPage++;
  renderPage(currentPage);
}

function prevPage(){
  if(currentPage <= 1) return;
  currentPage--;
  renderPage(currentPage);
}

document.getElementById("page-slider").addEventListener("input", function(){
  currentPage = parseInt(this.value);
  renderPage(currentPage);
});

/* ================= SCROLL MODE ================= */

function renderScroll(){
  for(let num = 1; num <= pdfDoc.numPages; num++){
    pdfDoc.getPage(num).then(function(page){

      let viewport = page.getViewport({scale: 1.2});
      let canvas = document.createElement("canvas");
      let ctx = canvas.getContext("2d");

      canvas.height = viewport.height;
      canvas.width = viewport.width;

      document.getElementById("pdf-container").appendChild(canvas);

      page.render({
        canvasContext: ctx,
        viewport: viewport
      });
    });
  }

  document.getElementById("progressBar").style.width = "0%";
}

/* ================= SAVE ================= */

function savePage(){
  localStorage.setItem(book + "-lastPage", currentPage);
}

/* ================= PROGRESS ================= */

function updateProgress(){
  let percent = (currentPage / pdfDoc.numPages) * 100;
  document.getElementById("progressBar").style.width = percent + "%";
}

/* ================= SWIPE (PAGE MODE) ================= */

let touchStartX = 0;

document.addEventListener("touchstart", function(e){
  if(mode !== "page") return;
  touchStartX = e.changedTouches[0].screenX;
});

document.addEventListener("touchend", function(e){
  if(mode !== "page") return;

  let touchEndX = e.changedTouches[0].screenX;

  if(touchEndX < touchStartX - 50) nextPage();
  if(touchEndX > touchStartX + 50) prevPage();
});

/* ================= DOUBLE CLICK FULLSCREEN ================= */

let lastTap = 0;

document.addEventListener("click", function(e){
  let currentTime = new Date().getTime();
  let tapLength = currentTime - lastTap;

  if(tapLength < 300 && tapLength > 0){
    toggleFullscreen();
  }

  lastTap = currentTime;
});

function toggleFullscreen(){
  if(!document.fullscreenElement){
    document.documentElement.requestFullscreen();
    document.body.classList.add("fullscreen");
  } else {
    document.exitFullscreen();
    document.body.classList.remove("fullscreen");
  }
}

</script>

</body>
</html>
